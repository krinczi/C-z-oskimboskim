<Window x:Class="POMIDOR.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:cmd="clr-namespace:POMIDOR"
        xmlns:local="clr-namespace:POMIDOR"
        Title="POMIDOR" Width="980" Height="640" WindowStartupLocation="CenterScreen"
        Background="#FFF6F7F9"
        Loaded="Window_Loaded">

    <Window.Resources>
        <!-- Widok kolekcji do listy -->
        <CollectionViewSource x:Key="TasksView" Source="{Binding Items}"/>
        <!-- Konwertery do grupowania po dniach i nagłówków -->
        <local:DayKeyConverter x:Key="DayKeyConv"/>
        <local:GroupHeaderConverter x:Key="GroupHeaderConv"/>
    </Window.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Pasek narzędzi -->
            <RowDefinition Height="*"/>
            <!-- Lista zadań -->
            <RowDefinition Height="Auto"/>
            <!-- Panel sub-tasków (Expander) -->
        </Grid.RowDefinitions>

        <!-- Pasek narzędzi -->
        <DockPanel Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="POMIDOR" FontSize="28" FontWeight="Black"
                       VerticalAlignment="Center"/>

            <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                <!-- Zakres czasu -->
                <TextBlock Text="Zakres:" Margin="12,0,6,0" VerticalAlignment="Center"/>
                <ComboBox x:Name="RangeBox" Width="120" SelectedIndex="1"
                          SelectionChanged="RangeBox_SelectionChanged">
                    <ComboBoxItem Content="Dzień"/>
                    <ComboBoxItem Content="Tydzień"/>
                    <ComboBoxItem Content="Miesiąc"/>
                </ComboBox>

                <!-- Nawigacja datą -->
                <Button Content="◀" Width="32" Height="28" Margin="10,0,0,0"
                        Click="Prev_Click"/>
                <Button Content="Dziś" Height="28" Margin="6,0,0,0"
                        Click="Today_Click"/>
                <Button Content="▶" Width="32" Height="28" Margin="6,0,0,0"
                        Click="Next_Click"/>

                <TextBlock x:Name="PeriodLabel" FontWeight="SemiBold" Margin="12,0,0,0"
                           VerticalAlignment="Center"/>

                <!-- Dodatkowe grupowanie -->
                <TextBlock Text="   Grupuj wg:" Margin="16,0,6,0" VerticalAlignment="Center"/>
                <ComboBox x:Name="GroupByBox" Width="140" SelectedIndex="0"
                          SelectionChanged="GroupByBox_SelectionChanged">
                    <ComboBoxItem Content="Brak"/>
                    <ComboBoxItem Content="Kategoria"/>
                    <ComboBoxItem Content="Cel"/>
                </ComboBox>

                <Button Content="Cele" Width="100" Height="34" Margin="12,0,0,0"
                        Click="OpenGoals_Click"/>
                <Button Content="Pomodoro" Width="110" Height="34" Margin="12,0,0,0"
                        Click="OpenPomodoro_Click"/>
                
                <Button Content="Analiza" Width="110" Height="34" Margin="12,0,0,0"
                        Click="OpenAnalytics_Click"/>

                <Button Content="Dodaj zadanie" Width="140" Height="34" Margin="12,0,0,0"
                        Click="AddTask_Click"/>
            </StackPanel>
        </DockPanel>

        <!-- Lista zadań -->
        <ListView x:Name="ItemsList" Grid.Row="1"
                  ItemsSource="{Binding Source={StaticResource TasksView}}">
            <!-- Styl elementów: double-click + context menu na komendach -->
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <EventSetter Event="MouseDoubleClick" Handler="Item_DoubleClick"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem Header="Edytuj"
                                          Command="{x:Static cmd:AppCommands.Edit}"
                                          CommandParameter="{Binding}"/>
                                <MenuItem Header="Usuń"
                                          Command="{x:Static cmd:AppCommands.Delete}"
                                          CommandParameter="{Binding}"/>
                                <Separator/>
                                <MenuItem Header="Oznacz jako ukończone"
                                          Command="{x:Static cmd:AppCommands.MarkDone}"
                                          CommandParameter="{Binding}"/>
                                <MenuItem Header="Oznacz jako nieukończone"
                                          Command="{x:Static cmd:AppCommands.MarkUndone}"
                                          CommandParameter="{Binding}"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListView.ItemContainerStyle>

            <!-- Styl tytułu (przekreślenie dla ukończonych) -->
            <ListView.Resources>
                <Style x:Key="TitleStyle" TargetType="TextBlock">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsCompleted}" Value="True">
                            <Setter Property="TextDecorations" Value="Strikethrough"/>
                            <Setter Property="Opacity" Value="0.55"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ListView.Resources>

            <!-- Grupowanie po dniach z nagłówkami -->
            <ListView.GroupStyle>
                <GroupStyle>
                    <GroupStyle.HeaderTemplate>
                        <DataTemplate>
                            <Border Background="#EEE" Padding="6" Margin="0,8,0,4">
                                <TextBlock Text="{Binding Name, Converter={StaticResource GroupHeaderConv}}"
                                           FontWeight="Bold"/>
                            </Border>
                        </DataTemplate>
                    </GroupStyle.HeaderTemplate>
                </GroupStyle>
            </ListView.GroupStyle>

            <ListView.View>
                <GridView>

                    <!-- Licznik sub-tasków -->
                    <GridViewColumn Header="Sub" Width="70">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock>
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0}/{1}">
                                            <Binding Path="SubTasksDone"  Mode="OneWay"/>
                                            <Binding Path="SubTasksTotal" Mode="OneWay"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <!-- Checkbox ukończone -->
                    <GridViewColumn Header="✓" Width="40">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <CheckBox IsChecked="{Binding IsCompleted, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <!-- Nazwa -->
                    <GridViewColumn Header="Nazwa" Width="220">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Title}" Style="{StaticResource TitleStyle}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <!-- Reszta pól -->
                    <GridViewColumn Header="Priorytet" Width="100"
                                    DisplayMemberBinding="{Binding Priority}"/>
                    <GridViewColumn Header="Termin" Width="120"
                                    DisplayMemberBinding="{Binding Due, StringFormat={}{0:yyyy-MM-dd}}"/>
                    <GridViewColumn Header="Kategoria" Width="120"
                                    DisplayMemberBinding="{Binding Category}"/>

                    <!-- Cel (edytowalny ComboBox) -->
                    <GridViewColumn Header="Cel" Width="170">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <ComboBox
                                    ItemsSource="{Binding DataContext.Goals, RelativeSource={RelativeSource AncestorType=Window}}"
                                    DisplayMemberPath="Name" SelectedValuePath="Name"
                                    SelectedValue="{Binding Goal, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                    IsEditable="True" />
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <GridViewColumn Header="Opis" Width="220"
                                    DisplayMemberBinding="{Binding Description}"/>

                    <!-- Procent postępu -->
                    <GridViewColumn Header="Postęp" Width="140">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <ProgressBar Minimum="0" Maximum="100" Height="14"
                                                 Value="{Binding ProgressPercent, Mode=OneWay}"/>
                                    <TextBlock Text="{Binding ProgressPercent, StringFormat={}{0}%}"
                                               HorizontalAlignment="Center" VerticalAlignment="Center"
                                               FontSize="11" FontWeight="SemiBold" Foreground="Black"/>
                                </Grid>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                    <!-- Akcje (z przyciskiem rozwijającym panel sub-tasków) -->
                    <GridViewColumn Header="Akcje" Width="210">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="Suby" Padding="8,2" Margin="0,0,6,0"
                                            Click="ShowSubs_Click"/>
                                    <Button Content="Edytuj" Padding="8,2" Margin="0,0,6,0"
                                            Click="Edit_Click"/>
                                    <Button Content="Usuń" Padding="8,2"
                                            Click="Delete_Click"/>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>

                </GridView>
            </ListView.View>
        </ListView>

        <!-- Panel sub-tasków (rozwijany) -->
        <Expander x:Name="SubsExpander" Grid.Row="2" Margin="0,12,0,0" IsExpanded="False">
            <Expander.Header>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock FontWeight="Bold"
                               Text="{Binding ElementName=ItemsList, Path=SelectedItem.Title,
                                              TargetNullValue=Subtaski (wybierz zadanie)}"/>
                    <!-- Pasek postępu wybranego zadania -->
                    <Grid Width="180" Height="12" Margin="12,0,0,0">
                        <ProgressBar Minimum="0" Maximum="100"
                                     Value="{Binding ElementName=ItemsList, Path=SelectedItem.ProgressPercent, Mode=OneWay}"/>
                        <TextBlock Text="{Binding ElementName=ItemsList, Path=SelectedItem.ProgressPercent, StringFormat={}{0}%}"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontSize="10" FontWeight="SemiBold"/>
                    </Grid>
                </StackPanel>
            </Expander.Header>

            <Border Padding="10" Background="#FFF" CornerRadius="6"
                    BorderBrush="#DDD" BorderThickness="1">
                <StackPanel>
                    <ListBox ItemsSource="{Binding ElementName=ItemsList, Path=SelectedItem.SubTasks}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="28"/>
                                        <!-- checkbox -->
                                        <ColumnDefinition Width="*"/>
                                        <!-- tytuł -->
                                        <ColumnDefinition Width="120"/>
                                        <!-- termin -->
                                        <ColumnDefinition Width="160"/>
                                        <!-- cel -->
                                        <ColumnDefinition Width="Auto"/>
                                        <!-- usuń -->
                                    </Grid.ColumnDefinitions>

                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsCompleted, Mode=TwoWay}"
                                              VerticalAlignment="Center"/>

                                    <TextBlock Grid.Column="1"
                                               Text="{Binding Title, Mode=OneWay}"
                                               TextWrapping="Wrap" />

                                    <TextBlock Grid.Column="2" HorizontalAlignment="Right" Margin="8,0,0,0">
                                        <Run Text="Termin: "/>
                                        <Run Text="{Binding Due, StringFormat={}{0:yyyy-MM-dd}}"/>
                                    </TextBlock>

                                    <!-- Cel sub-tasku -->
                                    <ComboBox Grid.Column="3" Margin="8,0,0,0" Width="150"
                                              ItemsSource="{Binding DataContext.Goals, RelativeSource={RelativeSource AncestorType=Window}}"
                                              DisplayMemberPath="Name" SelectedValuePath="Name"
                                              SelectedValue="{Binding Goal, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              IsEditable="True" />

                                    <Button Grid.Column="4" Content="Usuń" Margin="8,0,0,0"
                                            Click="RemoveSubFromPanel_Click"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </StackPanel>
            </Border>
        </Expander>
    </Grid>
</Window>
